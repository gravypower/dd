#!/usr/bin/with-contenv bashio
# ==============================================================================
# Start the dd service
# s6-overlay docs: https://github.com/just-containers/s6-overlay
# ==============================================================================

bashio::log.info "Starting dd..."

CREDENTIALS_FILE="/config/creds.json"

# Check for MQTT configuration
if bashio::config.has_value 'mqtt_host' && bashio::config.has_value 'mqtt_user' && bashio::config.has_value 'mqtt_password'; then

    # Read configuration values
    HOST=$(bashio::config 'host')
    MQTT_HOST=$(bashio::config 'mqtt_host')
    MQTT_PORT=$(bashio::config 'mqtt_port')
    MQTT_USERNAME=$(bashio::config 'mqtt_user')
    MQTT_PASSWORD=$(bashio::config 'mqtt_password')

    bashio::log.info "All required configurations are present. Starting the dd service..."

    # Execute the service
    exec /usr/bin/dd/haus -host "${HOST}" -mqtt "${MQTT_HOST}" -mqttPort "${MQTT_PORT}" -mqttUser "${MQTT_USERNAME}" -mqttPassword "${MQTT_PASSWORD}" -creds "${CREDENTIALS_FILE}"
else
    bashio::log.error "MQTT config not set correctley..."
fi